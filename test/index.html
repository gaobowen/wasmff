<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>demo2</title>
</head>
<script src="./html2canvas.min.js"></script>
<script src="./fileSaver.js"></script>

<body>
  <div id="root2" style="width: 1080px;height: 720px;">
    <div id="root"
      style="width: 1080px;height: 720px;background-color: sandybrown; position: absolute; left: 0; top: 0;">
      <div id="move" style="width: 100px; height: 100px; background-color: red; position: absolute; left: 0; top: 0;">
      </div>
    </div>
  </div>

  <div>
    <button onclick="ready()" style="font-size: large;">ready => </button>
    <button onclick="go()" style="font-size: large;">go => </button>
    <button onclick="download()" style="font-size: large;">download !</button>
    <!-- <button onclick="clip()" style="font-size: large;">clip</button> -->
    <div>
      <span>FrameIndex: </span>
      <span id="frameindex">0</span>
      <span>；TotalFrame: 800</span>
      <span>；width: 1080</span>
      <span>；height: 720</span>
      <span>；FPS: 25</span>
      <span>；CODEC: H264</span>
    </div>
  </div>

</body>
<script>
  var MP4Encoder = {
    isWASMLoaded : false,
    onRuntimeInitialized() {
      this.isWASMLoaded = true;
    }
  };
</script>
<script src="../bin/mp4encoder.js"></script>
<script>
  var getCStringPtr = function (jstr) {
    var lengthBytes = lengthBytesUTF8(jstr) + 1;
    var p = MP4Encoder._malloc(lengthBytes);
    stringToUTF8(jstr, p, lengthBytes);
    return p;
  }

  //file-saver
  let root = document.getElementById("root");
  let root2 = document.getElementById("root2");
  let move = document.getElementById("move");
  let idx = document.getElementById("frameindex");
  let d = 0;
  let stop = false;


  var ready = function () {
    console.log(MP4Encoder);
    stop = false;
    var pStr = getCStringPtr("/tmp/demo2.mp4");
    var ret = MP4Encoder._createH264(pStr, 1080, 720, 25);
    console.log("ready =>", ret ? "success" : "failed");
  }

  let step = async () => {
    move.style.left = d + "px";
    move.style.top = (d > 620 ? 620 * 2 - d : d) + "px";
    d += 2;
    idx.innerText = d;

    let canvas = await html2canvas(root, {
      x: 0,
      y: 0,
      width: 1080,
      height: 720,
      scale: 1
    });

    let ctx = canvas.getContext("2d");
    let imagedata = ctx.getImageData(0, 0, 1080, 720); //rgba

    let fileBuffer = new Uint8Array(imagedata.data.buffer);
    let bufferPtr = MP4Encoder._malloc(fileBuffer.length);
    MP4Encoder.HEAP8.set(fileBuffer, bufferPtr);
    var ret = MP4Encoder._addFrame(bufferPtr);
    MP4Encoder._free(bufferPtr);
  };

  var go = async () => {
    for (let i = 0; i < 400; i++) {
      let ret = await step();
      if (ret < 0 || stop) return;
    }
  };

  var download = () => {
    stop = true;
    MP4Encoder._close();
    var buff = FS.readFile('/tmp/demo2.mp4', { encoding: 'binary' });
    saveAs(new Blob([buff]), `demo2.mp4`);
  }



</script>

</html>